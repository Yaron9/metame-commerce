  ğŸ”— å®Œæ•´ç»‘å®šæµç¨‹ï¼ˆä¸‰ä¸ª ID çš„å…³è”ï¼‰                                                                      
                                                                                                         
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       
  â”‚  é£ä¹¦è´¦å·   â”‚         â”‚   åç«¯æ•°æ®åº“  â”‚         â”‚  ç”µè„‘ Daemon â”‚                                     
  â”‚ (user_id)   â”‚         â”‚  (account)   â”‚         â”‚(device_token)â”‚                                      
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       
         â”‚                        â”‚                         â”‚
         â”‚  1. OAuth ç™»å½•         â”‚                         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
         â”‚  è·å¾— open_id          â”‚                         â”‚
         â”‚                        â”‚                         â”‚
         â”‚  2. ç”Ÿæˆ bind_code     â”‚                         â”‚
         â”‚     (å¦‚ ABC123)        â”‚                         â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
         â”‚                        â”‚                         â”‚
         â”‚  3. æ‰«ç åŠ  Bot         â”‚                         â”‚
         â”‚     (å¯æ”¶å‘æ¶ˆæ¯)        â”‚                         â”‚
         â”‚                        â”‚                         â”‚
         â”‚                        â”‚  4. Daemon è¿ Relay     â”‚
         â”‚                        â”‚     ç”Ÿæˆ device_token   â”‚
         â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                        â”‚                         â”‚
         â”‚                        â”‚  5. ç”¨æˆ·è¾“å…¥ ABC123     â”‚
         â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                        â”‚                         â”‚
         â”‚                        â”‚  6. éªŒè¯ç»‘å®š            â”‚
         â”‚                        â”‚   account.device_token  â”‚
         â”‚                        â”‚   = å½“å‰ Daemon çš„ tokenâ”‚
         â”‚                        â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ… å®Œæˆç»‘å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              é£ä¹¦æ¶ˆæ¯å¯ä»¥è·¯ç”±åˆ°è¿™å°ç”µè„‘äº†

  ğŸ¯ å…·ä½“å®ç°æ­¥éª¤

  Step 1: ç½‘ç«™ç”Ÿæˆç»‘å®šç 

  // åç«¯ /api/auth/feishu
  const account = createAccount(feishuUserId, ...);
  const bindCode = "ABC123"; // 6ä½éšæœºç 
  saveToDatabase(bindCode, account.id);
  return { bind_code: bindCode };

  Step 2: Desktop App æä¾›è¾“å…¥ç•Œé¢

  // Desktop App UIï¼ˆä½ æˆªå›¾é‡Œå·²ç»æœ‰äº†ï¼ï¼‰
  ç”¨æˆ·çœ‹åˆ°ï¼š"ç»‘å®šé£ä¹¦"æŒ‰é’®
  ç‚¹å‡»åå¼¹çª—è¾“å…¥ bind_code

  Step 3: Desktop App è°ƒç”¨ç»‘å®š API

  // Desktop App
  const deviceToken = getCurrentDeviceToken(); // ä» Relay è·å–
  await fetch('/api/bind/verify', {
    method: 'POST',
    body: JSON.stringify({
      bind_code: userInput,      // ç”¨æˆ·è¾“å…¥çš„ ABC123
      device_token: deviceToken  // å½“å‰ Daemon çš„ token
    })
  });

  Step 4: åç«¯å®Œæˆç»‘å®š

  // API /api/bind/verify
  const account = findAccountByBindCode(bind_code);
  if (!account) return error("Invalid code");

  // å…³é”®ï¼šæŠŠ device_token å†™å…¥ account è¡¨
  updateAccount(account.id, { device_token });

  // å¯é€‰ï¼šé€šçŸ¥ Relay è¿™ä¸ªæ˜ å°„å…³ç³»
  notifyRelay({
    feishu_user_id: account.feishu_user_id,
    device_token: device_token
  });

  Step 5: Relay è·¯ç”±æ¶ˆæ¯

  // Relay æ”¶åˆ°é£ä¹¦æ¶ˆæ¯
  const message = webhook.user_id; // é£ä¹¦ user_id
  const account = findAccountByFeishuId(message.user_id);
  const deviceToken = account.device_token;

  // é€šè¿‡ WebSocket å‘é€åˆ°å¯¹åº”çš„ Daemon
  relay.sendToDevice(deviceToken, message);

  ---
  ğŸ“ éœ€è¦æ·»åŠ çš„ä»£ç 

  åªéœ€è¦æ·»åŠ ä¸€ä¸ª API ç«¯ç‚¹ï¼š

  // /api/bind/verify
  router.post('/verify', async (req, res) => {
    const { bind_code, device_token } = req.body;

    const codeRecord = getBindCodeFromDB(bind_code);
    if (!codeRecord || codeRecord.status !== 'pending') {
      return res.status(400).json({ error: 'Invalid or expired code' });
    }

    // ç»‘å®šï¼
    updateAccount(codeRecord.account_id, {
      device_token,
      device_name: 'Desktop'
    });

    // æ ‡è®° code å·²ä½¿ç”¨
    updateBindCode(bind_code, { status: 'used' });

    res.json({ success: true });
  });

  ---
  âœ… æ€»ç»“

  ç­”æ¡ˆï¼šé€šè¿‡ 6ä½ç»‘å®šç  ä½œä¸º"æ¡¥æ¢"ï¼ŒæŠŠä¸‰ä¸ª ID å…³è”èµ·æ¥ï¼š

  1. é£ä¹¦ user_id â†’ ç½‘ç«™ OAuth â†’ ç”Ÿæˆ bind_code
  2. ç”¨æˆ·åœ¨ Desktop App è¾“å…¥ bind_code
  3. Desktop App è°ƒç”¨ APIï¼ŒæŠŠè‡ªå·±çš„ device_token å’Œ bind_code ç»‘å®š
  4. åç«¯æ•°æ®åº“è®°å½•ï¼šfeishu_user_id â†” account_id â†” device_token
  5. é£ä¹¦æ¶ˆæ¯æ¥äº† â†’ æŸ¥è¡¨ â†’ æ‰¾åˆ° device_token â†’ è·¯ç”±åˆ°å¯¹åº” Daemon

  è¦ä¸è¦æˆ‘ç°åœ¨å°±å®ç°è¿™ä¸ª /api/bind/verify æ¥å£ï¼Ÿ è¿™æ ·æ•´ä¸ªæµç¨‹å°±é€šäº†ã€‚